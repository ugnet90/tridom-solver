name: Tridom Solver (Sharded + Summary)

on:
  workflow_dispatch:
    inputs:
      shape:
        description: "A, B oder AB"
        required: true
        default: "A"
      shard_minutes:
        description: "Laufzeit pro Shard in Minuten"
        required: true
        default: "30"
      shards:
        description: "Anzahl Shards (empfohlen 12–30)"
        required: true
        default: "12"

jobs:
  solve:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      matrix:
        shard: [1,2,3,4,5,6,7,8,9,10,11,12]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install matplotlib

      - name: Run shard
        run: |
          SEED=$((10000 + ${{ matrix.shard }}))
          TL=$(( ${{ inputs.shard_minutes }} * 60 ))
          PREFIX="shard_${{ matrix.shard }}_"
          python tridom_solver.py --shape "${{ inputs.shape }}" --time-limit "$TL" --seed "$SEED" --log "${PREFIX}run.log" --out-prefix "$PREFIX"

      - name: Upload shard results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tridom-results-shard-${{ matrix.shard }}
          path: |
            shard_${{ matrix.shard }}_*.png
            shard_${{ matrix.shard }}_*.pdf
            shard_${{ matrix.shard }}_run.log
            shard_${{ matrix.shard }}_status.json

  summary:
    runs-on: ubuntu-latest
    needs: [solve]
    if: always()

    steps:
      - name: Download all shard artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tridom-results-shard-*
          merge-multiple: true
          path: shards

      - name: Build summary
        run: |
          python - << 'PY'
          import json, glob, os, csv

          status_files = sorted(glob.glob("shards/shard_*_status.json"))
          rows = []
          for f in status_files:
            with open(f, "r", encoding="utf-8") as fp:
              d = json.load(fp)
            # infer shard number from filename
            base = os.path.basename(f)
            shard = base.split("_")[1]  # shard_<N>_status.json
            rows.append({
              "shard": int(shard),
              "shape": d.get("shape"),
              "solved": d.get("solved"),
              "best_filled": d.get("best_filled"),
              "nodes": d.get("nodes"),
              "elapsed_s": round(d.get("elapsed_s", 0), 2),
              "seed": d.get("seed"),
              "time_limit_s": d.get("time_limit_s"),
              "triangles": d.get("triangles"),
              "vertices": d.get("vertices"),
            })

          rows.sort(key=lambda r: (0 if r["solved"] else 1, -(r["best_filled"] or 0), -(r["nodes"] or 0)))

          # Write CSV
          os.makedirs("summary", exist_ok=True)
          csv_path = "summary/summary.csv"
          with open(csv_path, "w", newline="", encoding="utf-8") as f:
            w = csv.DictWriter(f, fieldnames=list(rows[0].keys()) if rows else ["shard"])
            w.writeheader()
            for r in rows:
              w.writerow(r)

          # Write Markdown summary
          md_path = "summary/summary.md"
          lines = []
          lines.append("# Tridom Solver – Summary")
          lines.append("")
          if not rows:
            lines.append("Keine `status.json` gefunden.")
          else:
            solved = [r for r in rows if r["solved"]]
            best = rows[0]
            lines.append(f"- Shards ausgewertet: **{len(rows)}**")
            lines.append(f"- Lösungen gefunden: **{len(solved)}**")
            lines.append("")
            lines.append("## Beste Resultate (Top 10)")
            lines.append("")
            lines.append("| Rank | Shard | Shape | Solved | Best Filled | Nodes | Elapsed (s) | Seed |")
            lines.append("|---:|---:|:---:|:---:|---:|---:|---:|---:|")
            for i, r in enumerate(rows[:10], start=1):
              lines.append(f"| {i} | {r['shard']} | {r['shape']} | {r['solved']} | {r['best_filled']} | {r['nodes']} | {r['elapsed_s']} | {r['seed']} |")

            lines.append("")
            lines.append("## Interpretation")
            lines.append("")
            if solved:
              lines.append("Mindestens ein Shard hat eine vollständige Lösung gefunden. Lade das entsprechende Artifact `tridom-results-shard-<N>` herunter und prüfe `solution_*.png/.pdf`.")
            else:
              lines.append("Es wurde in diesen Shards keine vollständige Lösung gefunden. Das ist **kein formaler Unmöglichkeitsbeweis**, aber ein starkes Indiz. Nächster Schritt: mehr Shards, anderes Zeitlimit, oder alternative B-Form.")
          with open(md_path, "w", encoding="utf-8") as f:
            f.write("\n".join(lines))

          print("Wrote", md_path, "and", csv_path)
          PY

      - name: Upload summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tridom-summary
          path: |
            summary/summary.md
            summary/summary.csv